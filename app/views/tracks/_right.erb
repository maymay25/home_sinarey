<%
# 有专辑的声音记录
tirs_in_album = TrackInRecord.stn(params[:id]).where("status = 1 and is_deleted = 0 and is_public = 1 and track_id = ? and album_id is not null", params[:id]).limit(6)
if tirs_in_album.count > 0
  tia_tracks_counts = $counter_client.getByIds(Settings.counter.album.tracks, tirs_in_album.map{|tia| tia.album_id})
else
  tia_tracks_counts = []
end

favorites_count = $counter_client.get(Settings.counter.track.favorites, tir.track_id)

lovers = Lover.stn(params[:id]).where(track_id: params[:id]).select('uid, nickname, avatar_path, is_v').order("created_at desc").limit(10)
if lovers.count > 0
  uids = lovers.map{|l| l.uid}
  lover_tracks_counts = $counter_client.getByIds(Settings.counter.user.tracks, uids)
  lover_followers_counts = $counter_client.getByIds(Settings.counter.user.followers, uids)
else
  lover_tracks_counts, lover_followers_counts = [], []
end

trackrich = TrackRich.stn(params[:id]).where(track_id: params[:id]).select('lyric').first
lyric = Sanitize.clean(CGI.unescapeHTML(CGI.unescapeHTML(trackrich.lyric)), { elements: %w(br) }) if trackrich && trackrich.lyric && tir.is_v
%>

<div class="ad1">
  <%== erb :_advertise, locals: { id: 727912, width:'200px',height:'80px' } %>
</div>

<% if tirs_in_album.size > 0 %>
<!-- 收录专辑 -->
<div class="albumBar">
  <div class="titleBar">
    <h2 class="title">收录专辑</h2>
  </div>
  <ul>
    <% tirs_in_album.each_with_index do |r, i| %>
    <li sound_id="<%= r.track_id %>">
      <div class="albumPanelBar2">
        <div class="left">
        <a class="albumface100" href="<%= link_path("/#{r.uid}/album/#{r.album_id}") %>">
          <span>
            <img alt="<%= r.album_title %>" src="<%= picture_url('album', r.album_cover_path, '100') %>" data-options="defaultImg:album_100">
          </span>
        </a>
        </div>
        <div class="right">
          <a href="<%= link_path("/#{r.uid}/album/#{r.album_id}") %>" title="<%= r.album_title %>"><%= cut_str(r.album_title,16) %></a>
          <span><%= tia_tracks_counts[i] %>个声音</span>
        </div>
      </div>
    </li>
    <% end %>
  </ul>
</div>
<% end %>

<% if lovers.size > 0 %>
<!--赞该声音的人-->
<div class="fansBar mgT20">
  <div class="titleBar">
    <a href="<%= link_path "/#{tir.uid}/sound/#{tir.track_id}/liker" %>" class="more">更多</a>
    <h2 class="title">赞该声音的人(<%= favorites_count %>)</h2>
  </div>
  <div class="fans_content">
    <% lovers.each_with_index do |lover, i| %>
    <a href="<%= link_path "/#{lover.uid}/" %>">
      <img src="<%= picture_url('header', lover.avatar_path, 60) %>" alt="<%= lover.nickname %>" card="<%= lover.uid %>" title="<%= lover.nickname %>">
    </a>
    <% end %>
  </div>
</div>
<% end %>

<% if lyric and !lyric.strip.empty? and !["<br>","<br/>","<br />"].include?(lyric) %>
<!--歌词/文案-->
<div class="lyricBar mgT30">
  <div class="lyricTitleBar">歌词/文案</div>
  <div class="lyricPanelBar">
    <%= lyric.html_safe  %>
  </div>
</div>
<% end %>

<%
  #Ta的其它声音
  # all_t = TrackRecord.stn(tir.uid).where(uid: tir.uid, is_public: true, is_deleted: false, status: 1, transcode_state: 2)
  # album_condition = tir.album_id && ["album_id != ?",tir.album_id]
  # other_tracks = []
  # album = Album.stn(tir.uid).where(uid:tir.uid, id: tir.album_id, is_deleted: false).first
  # if album
  #   album_tracks_order = []
  #   all_album_t = all_t.where(album_id: album.id)
  #   is_user_order = (!album.is_crawler && album.tracks_order.present? && album.tracks_order != "")
  #   if is_user_order
  #     album_tracks_order = album.tracks_order.split(",")
  #     index = album_tracks_order.index("#{tir.id}")
  #   else
  #     index = all_album_t.order('order_num asc, id desc').collect{|t|t.id}.index(tir.id)
  #   end
  #   if index
  #     offset = index > 3 ? (index - 3) : 0
  #     if is_user_order
  #       album_t = all_album_t.order("field(id,#{album_tracks_order.join(',')})").offset(offset).limit(7)
  #     else
  #       album_t = all_album_t.order('order_num asc, id desc').offset(offset).limit(7) 
  #     end
  #   else
  #     album_t = all_album_t.order('order_num asc, id desc').limit(7) 
  #   end
  #   other_tracks = album_t.to_a.delete_if{|t| t.track_id == tir.track_id }
  # end
  # need_more_count = 6 - other_tracks.count
  # if need_more_count > 0
  #   n1 = need_more_count > 3 ? 3 : need_more_count
  #   n1_tracks = all_t.where(album_condition).where("track_id > ? ",tir.track_id).order('track_id asc').limit(n1).to_a.reverse
  #   other_tracks += n1_tracks
  #   n2 = need_more_count - n1_tracks.count
  #   if n2 > 0
  #     other_tracks += all_t.where(album_condition).where("track_id < ? ",tir.track_id).order('track_id desc').limit(n2).to_a
  #   end
  # end
  other_tracks = TrackRecord.stn(tir.uid).where('uid = ? and is_public = 1 and is_deleted = 0 and status = 1 and transcode_state = 2 and created_at > ?', tir.uid, tir.created_at).limit(3).to_a.reverse
  other_tracks += TrackRecord.stn(tir.uid).where('uid = ? and is_public = 1 and is_deleted = 0 and status = 1 and transcode_state = 2 and created_at < ?', tir.uid, tir.created_at).order('created_at desc').limit(3).to_a

%>

<% if other_tracks.count > 0 %>
<%
  album_records_plays = $counter_client.getByIds(Settings.counter.track.plays, other_tracks.map{|r| r.track_id})
%>
<div class="soundBar mgT20">
  <div class="titleBar">
    <a href="<%= link_path("/#{tir.uid}/sound/") %>" class="more">更多</a>
    <h2 class="title">Ta的其它声音</h2>
  </div>
  <ul>
      <% other_tracks.each_with_index do |r, i| %>
      <li>
        <div class="soundPanelBar3">
          <a class="title" title="<%= r.title %>" href="<%= link_path("/#{r.uid}/sound/#{r.track_id}") %>"><%= r.title %></a>
          <span class="times" title="<%= album_records_plays[i] %>次播放"><%= album_records_plays[i] %>次</span>
        </div>
      </li>
      <% end %>
  </ul>
</div>  
<% end %>
